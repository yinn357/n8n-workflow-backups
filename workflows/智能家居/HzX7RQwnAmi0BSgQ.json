{
  "active": true,
  "connections": {
    "toMarkdown内容": {
      "main": [
        [
          {
            "node": "md-钉钉通知",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "定时变量日志": {
      "main": [
        [
          {
            "node": "查询临时表",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "查询临时表": {
      "main": [
        [
          {
            "node": "toMarkdown内容",
            "type": "main",
            "index": 0
          },
          {
            "node": "清空临时表",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "清空临时表": {
      "main": [
        []
      ]
    },
    "查询临时表条数": {
      "main": [
        [
          {
            "node": "条数大于10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "条数大于10": {
      "main": [
        [
          {
            "node": "查询临时表",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "子流程触发": {
      "main": [
        [
          {
            "node": "查询临时表条数",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-08-14T02:48:24.565Z",
  "id": "HzX7RQwnAmi0BSgQ",
  "isArchived": false,
  "meta": null,
  "name": "sub-HA全局变量-定时通知",
  "nodes": [
    {
      "parameters": {
        "jsCode": "/**\n * 将数据数组转换成 Markdown Table 格式\n */\nfunction toMarkdownTable(jsonArray, ignoreFields = []) {\n  const headers = Object.keys(jsonArray[0].json).filter(h => !ignoreFields.includes(h));\n  const headerRow = '| ' + headers.join(' | ') + ' |';\n  const separatorRow = '| ' + headers.map(() => '---').join(' | ') + ' |';\n\n  const dataRows = jsonArray.map(obj =>\n    '| ' + headers.map(h => String(obj.json[h]).replace(/\\|/g, '\\\\|')).join(' | ') + ' |'\n  );\n\n  return [headerRow, separatorRow, ...dataRows].join('\\n');\n}\nconst ignoreFields = ['源数据', '_id', 'id', 'keys'];\nlet tableMd = toMarkdownTable($input.all(), ignoreFields);\n\n/**\n * 将数据数组转换成 Markdown 形式：\n * ### HH:MM\n * - 人: x    灯: y    器: z\n */\nfunction toSimpleMd(data) {\n  return data.map(item => {\n    const json = item.json\n    // 截取时间中的时:分\n    const hhmm = json['时间']?.slice(11, 16);\n    const people = json['有人'];\n    const lamps  = json['灯光数量'];\n    const devices= json['家电数量'];\n    // return `### ${hhmm}\\n- 人: ${people}\\t灯: ${lamps}\\t器: ${devices}`;\n    return `- 🕦${hhmm} 🧍‍${people} 💡${lamps} 🔌${devices}`;\n    \n  }).join('\\n');\n}\n\nlet listMd = toSimpleMd($input.all());\nreturn [{\n  json:{tableMd,listMd}\n}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        768,
        -112
      ],
      "id": "e195b2e8-1d01-42ff-b629-2d84f55f0757",
      "name": "toMarkdown内容"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "4tHTAEVO9ryUxOhn",
          "mode": "list",
          "cachedResultName": "sub-钉钉通知"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "msgtype": "md",
            "content": "={{ $json.listMd }}",
            "title": "米家变量记录",
            "name": "米家变量记录"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "msgtype",
              "displayName": "msgtype",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "content",
              "displayName": "content",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "name",
              "displayName": "name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        992,
        -112
      ],
      "id": "9b983ebc-412e-4454-aba5-1c3236ed5da8",
      "name": "md-钉钉通知"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 2,
              "triggerAtMinute": 13
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        320,
        -112
      ],
      "id": "827a3468-f7cc-4040-96c2-446c29addebf",
      "name": "定时变量日志"
    },
    {
      "parameters": {
        "db_path": "=/files/database/home-assistant.db",
        "query_type": "SELECT",
        "query": "SELECT * FROM global_variables_temp",
        "spread": true
      },
      "type": "n8n-nodes-sqlite3.sqliteNode",
      "typeVersion": 1,
      "position": [
        544,
        -208
      ],
      "id": "29d18ef5-f867-498b-ba25-eb06365b4878",
      "name": "查询临时表",
      "executeOnce": false
    },
    {
      "parameters": {
        "db_path": "=/files/database/home-assistant.db",
        "query_type": "DELETE",
        "query": "DELETE FROM global_variables_temp"
      },
      "type": "n8n-nodes-sqlite3.sqliteNode",
      "typeVersion": 1,
      "position": [
        768,
        -304
      ],
      "id": "a8bf38e7-8907-4588-9384-db23bc3ac1d5",
      "name": "清空临时表",
      "executeOnce": true
    },
    {
      "parameters": {
        "db_path": "/files/database/home-assistant.db",
        "query_type": "SELECT",
        "query": "select COUNT(1) num from global_variables_temp",
        "spread": true
      },
      "type": "n8n-nodes-sqlite3.sqliteNode",
      "typeVersion": 1,
      "position": [
        96,
        -304
      ],
      "id": "83221407-6066-4267-be16-47ceecb23391",
      "name": "查询临时表条数",
      "executeOnce": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "27f5f618-1239-429f-95a3-39e06187592f",
              "leftValue": "={{ $json.num }}",
              "rightValue": 10,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        320,
        -304
      ],
      "id": "3d42af4a-4dda-4c33-93a7-9abe750941ef",
      "name": "条数大于10"
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -128,
        -304
      ],
      "id": "b7973840-ff97-4285-aac4-e31c5d14b223",
      "name": "子流程触发"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-08-14T02:48:24.586Z",
      "updatedAt": "2025-08-14T02:48:24.586Z",
      "role": "workflow:owner",
      "workflowId": "HzX7RQwnAmi0BSgQ",
      "projectId": "BeX3bor8ts20lbDK"
    }
  ],
  "staticData": {
    "node:定时变量日志": {
      "recurrenceRules": [
        6
      ]
    },
    "node:Schedule Trigger": {
      "recurrenceRules": []
    },
    "node:定时10分钟": {
      "recurrenceRules": []
    }
  },
  "tags": [
    {
      "createdAt": "2025-06-26T06:14:33.448Z",
      "updatedAt": "2025-06-26T06:14:33.448Z",
      "id": "FHV017iDd8qf8jAL",
      "name": "智能家居"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-08-15T00:47:45.000Z",
  "versionId": "ff6843df-283e-4fef-ac51-056d5d3668c8"
}